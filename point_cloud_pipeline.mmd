graph LR
    classDef proc fill:#e6f3ff,stroke:#0066cc,stroke-width:2px
    classDef input fill:#f0f0f0,stroke:#333,stroke-width:2px
    classDef output fill:#d4edda,stroke:#155724,stroke-width:2px
    classDef vis fill:#fff3cd,stroke:#856404,stroke-width:2px

    %% Step 1: Load PLY Files
    A1["PLY Files in Folder"]:::input -->|Read PLY files| A2["Load Point Clouds"]:::proc
    A2 --> A3["Scale & Flip Z"]:::proc
    A3 --> A4["Transformed Point Clouds"]:::output

    %% Step 2: Process Each Point Cloud
    A4 --> B1["Process Each Point Cloud"]:::proc
    B1 --> B2["Refine Point Cloud"]:::proc
    B1 --> B3["Downsample (voxel_size_)"]:::proc
    B1 --> B4["Remove Outliers (nb_neighbors_, std_ratio_)"]:::proc
    B2 --> B5["Refined Point Cloud"]:::output
    B3 --> B5
    B4 --> B5

    B5 --> C1["Segment Plane"]:::proc
    C1 --> C2["RANSAC (threshold 0.006, ransac_n_, num_iterations_)"]:::proc
    C2 --> C3["Extract Non-Plane Points"]:::proc
    C3 --> C4["Non-Plane Point Cloud"]:::output

    %% Step 3: Merge Point Clouds
    C4 --> D1["Collect & Merge Non-Plane Clouds"]:::proc
    D1 --> D2["Merged Point Cloud"]:::output
    D2 --> D3["Visualize Merged Cloud"]:::vis
    D3 --> D4["Screenshot Merged"]:::output

    %% Step 4: Cluster Merged Point Cloud
    D2 --> E1["Cluster Merged Cloud"]:::proc
    E1 --> E2["DBSCAN (cluster_tolerance_, min_cluster_size_)"]:::proc
    E2 --> E3["Clusters"]:::output

    E3 --> E4["Visualize Clusters"]:::vis
    E4 --> E5["Screenshot Clusters"]:::output
    E3 --> E6{"Debug Mode?"}:::proc
    E6 -->|Yes| E7["Visualize Clusters Separately"]:::vis

    linkStyle default stroke:#333,stroke-width:2px